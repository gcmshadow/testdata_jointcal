jointcal test data
==================

This repository contains data to test the performance of the [jointcal](http://github.com/lsst/jointcal) product. Test data for jointcal needs to have multiple visits of the same field, processed with the LSST DM stack to get VisitInfo metadata and source catalogs.

Individual sets of testing data should be placed in their own directories, as butler-accessible repositories. They can then be loaded in testing code via the butler and the catalogs fed to jointcal. The image HDUs in the calexps in each repo have been set to identically zero and then compressed to save space, since the calexps are only needed for the calexp_md metadata.

The directories contained in this repository are listed below, with a description of their contents.

The `cfht`, `decam`, and `hsc` directories each contain a `ref_cats/` directory with `sdss-dr9-fink-v5b`, `gaia_dr2_20191105` and `ps1_pv3_3pi_20170110` reference catalogs in indexed HTM format.
The sdss refcats were copied from their respective `validation_data_*/` repositories' `ref_cats/` directory.
The Gaia and PS1 refcats were extracted from the respective refcats on lsst-dev using the `scripts/extract-refcat-shards.py` script.

cfht
----

Source catalogs, metadata, and zeroed+compressed images derived from [validation_data_cfht](https://github.com/lsst/validation_data_cfht), processed with a version of the stack that provides VisitInfo (afw post-`tickets/DM-8052` merge: git hash 22f008f).

Then the `icExp/`, `icSrc/`, and `srcMatch` directories were deleted from `cfht/` and the calexps were processed via the included `compress_jointcal_cfht_test_data.py` to remove the pixel-level data and gzip compress them to make their size reasonable. I saved a skyMap to deepCoadds, generated by running:

```
makeDiscreteSkyMap.py cfht --output cfht/deepCoadd --id visit=850587^840375 ccd=12 --configfile makeSkyMapConfig.py
```

and this makeSkyMapConfig.py,

```
config.skyMap.projection='TAN'

# dimensions of inner region of patches (x,y pixels)
config.skyMap.patchInnerDimensions=[4000, 4000]

# nominal pixel scale (arcsec/pixel)
config.skyMap.pixelScale=0.185
```

cfht_minimal
------------

Useful for debugging photometry code. A "minimal" catalog extracted from cfht (see above), containing 2 ccds with 2 sources each.
Two sources in one catalog have a refcat match (using the `cfht` `sdss-dr9-fink-v5b` reference catalog), and one source is matched between the catalogs.
Contains `ccd=12` with (0-indexed) `rows=336,337` of `visit=850587` and `rows=139,140` for `visit=849375`.
In jointcal, the photometry fit will contain 3 valid measuredStars, 2 fittedStars, and 2 refStars.

decam
-----

Source catalogs, metadata, and zeroed+compressed images derived from [validation_data_decam](https://github.com/lsst/validation_data_decam), processed with a version of the stack that provides VisitInfo (afw post-`tickets/DM-8052` merge: git hash 22f008f).

The `bkgd/`, `icMatch/`, and `icSrc/` directories were deleted from the visit sub-directories and the calexps were processed via the included `compress_jointcal_decam_test_data.py` to remove the pixel-level data and gzip compress them to make their size reasonable. The source catalogs were gzipped to reduce their size. I saved a skyMap to `deepCoadds/`, generated by running:

```
makeDiscreteSkyMap.py cfht --output data/deepCoadd --id visit=0176837^0176846 --configfile makeSkyMapConfig.py
```

and this makeSkyMapConfig.py:


```
config.skyMap.projection='TAN'

# dimensions of inner region of patches (x,y pixels)
config.skyMap.patchInnerDimensions=[4000, 4000]

# nominal pixel scale (arcsec/pixel)
config.skyMap.pixelScale=0.263
```

hsc
---

Source catalogs, metadata, and zeroed+compressed images derived from an earlier non-full-focalplane version of [validation_data_hsc](https://github.com/lsst/validation_data_hsc) ([git hash: f20a3ec](https://github.com/lsst/validation_data_hsc/commit/f20a3ec9ab1e17b40f46429711ef2d185a4d6596), processed with a version of the stack that provides VisitInfo (afw post-`tickets/DM-8052` merge: git hash 22f008f). This data includes two filters (R and I) with 11 total visits, 2-4 CCDs per visit from different parts of the focal plane.

The commands that were run to produce this repo, from within the `DATA` directory of a clone of the validation_data_hsc repo at the commit linked above:

```bash
setup testdata_jointcal
setup obs_subaru
setup pipe_drivers

export OMP_NUM_THREADS=1

export SETUP_ASTROMETRY_NET_DATA="astrometry_net_data sdss-dr9-fink-v5b"
export ASTROMETRY_NET_DATA_DIR=`pwd`/sdss-dr9-fink-v5b

# change this directory to where you want the processed data to live
export OUTPUT=$TESTDATA_JOINTCAL_DIR/hsc
echo lsst.obs.hsc.HscMapper > $OUTPUT/_mapper
ingestImages.py $OUTPUT --mode=link 'STRIPE82L/*/*/HSC-?/*.fits'

# older few-chip-per-visit data
VISIT=903334^903336^903338^903342^903344^903346^903986^903988^903990^904010^904014

singleFrameDriver.py $OUTPUT --calib CALIB --output $OUTPUT --job singleFrame --cores 4 --id visit=$VISIT --clobber-config --clobber-versions
makeDiscreteSkyMap.py $OUTPUT --output $OUTPUT --id visit=$VISIT --clobber-versions
```

The following directories and files were deleted, and the calexps were processed via the included `compress_jointcal_hsc_test_data.py` to remove the pixel-level data and gzip compress them to make their size reasonable. The source catalogs were gzipped to reduce their size.

```
hsc/00*/HSC-?/output/ICSRC-*.fits
hsc/00*/HSC-?/thumbs/
hsc/00*/HSC-?/corr/BKGD-*
hsc/00*/HSC-?/corr/ICEXP*
```

Git LFS
-------

To clone and use this repository, you'll need Git Large File Storage (LFS).

Our [Developer Guide](http://developer.lsst.io/en/latest/tools/git_lfs.html)
explains how to set up Git LFS for LSST development.
